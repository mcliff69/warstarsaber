<h1>Световой меч версия 2.0</h1>
<p>
За основу был взят проект: <a href="https://alexgyver.ru/arduino-lightsaber/">КРУТЕЙШИЙ СВЕТОВОЙ МЕЧ СВОИМИ РУКАМИ</a> от Алекса Гайвера
</p>
<p>
Главное отличие - это генерация звука через модуль DFPlayer вместо чтения карты напрямую и генерации звука программным способом через ШИМ. Новый способ даёт много плюсов: 
<br>- качество звука намного лучше;
<br>- контроллер освобождается от лишней работы;
<br>- работает намного стабильнее. Когда собрал первый меч по проекту Алекса, он достаточно часто глючил. Думаю, библиотека генерации звука сырая или не хватает памяти;
<br>- не надо конвертировать файлы в определенный формат, можно использовать обычный MP3;
<br>- не надо высчитывать длительность разных звуков и следить программно, когда они закончат проигрываться;
<br>- легко можно добавлять свои звуки или заменить на свой кастомный набор звуков;
<br>- освобождается 50% памяти под другие фичи.
<br>Из минусов вижу только маленькую паузу 0.1 сек, которая присутствует в начале каждого MP3 файла, и от которой нет возможности избавиться. Это вызывает неприятное ощущение рассинхронизации при ударе меча. Но только если специально обращать на это внимание.
<br>Еще иногда (достаточно редко) MP3 модуль зависает на несколько секунд. При этом меч перестает реагировать на кнопки и моргать. Но потом всё отвисает и продолжает работать. Под дебагом видно, что модуль возвращает какую-то ошибку. Но не стал с этим разбираться, так как это происходит редко, и ошибка происходит в самом DFPlayer, а не в контроллере.
</p>


<h2>Управление и основные возможности меча</h2>
      <h3>Включение питания.</h3> 
<p>
	  При включении питания (кнопка со светодиодом) меч плавно загорается на 2 сек, показывая процент зарядки. Меч переходит в выключенное состояние.
      Подсчитывается количество файлов в каждой папке на карте. 
      Можно записать любые mp3 файлы в любом количестве. 
      Имена файлов должны быть от 001.mp3 и далее подряд.
</p>
      
      
      <h3>В выключенном состоянии.</h3>
<p>
      1. Нажатие кнопки 1 более 0.8 секунд - включение меча. Если заряд меньше 10%, то не включается. Если больше, то плавно загорается и проигрывается звук включения.
	  <br>
      2. Нажатие кнопки 1 более 3 секунд - включение и переключение режимов горения: Меч - Лампа - Факел по кругу через каждые 3 сек. 
      <br>
	  В режиме Лампа просто светит без звука. 
      <br>
	  В режиме Факел имитирует огонь со звуком огня. Файл "09/002.mp3" на карте.
      <br>
	  3. Если питание включено, но меч не включен, то через 10 минут воспроизводится напоминание, что нужно выключить питание. Файл "09/003.mp3" на карте. Дальше напоминание повторяется каждую минуту.
</p>
      
      <h3>Во включенном состоянии.</h3>
<p>
      1. Короткое нажатие кнопки 1 переключает цвет по кругу: 
        Красный - Оранжевый - Жёлтый - Зелёный - Голубой - Синий - Фиолетовый - Белый.
        Если в режиме факела, переключается палитра пламени.
      <br>
	  2. Короткое нажатие кнопки 2 в режиме меча взависимости от настроек
      <br>
	  - переключает фоновую музыку (гудение) + режим трещания по кругу или
      <br>
	  - воспроизводит произвольно выбранную звуковую цитату - файл из папки "08" на карте. 
      <br>
	  3. Одновременное нажатие кнопок 1 и 2 переводит в режим регулировки громкости. 
        Светодиод начинает моргать.
      <br>
	  4. Нажатие кнопки 1 более 0.8 секунд - выключение меча. Проигрывается звук выключения и плавно гасится.
      <br>
	  5. Нажатие кнопки 2 более 0.8 секунд - переход в настройки. Светодиод начинает моргать.
      <br>
	  6. Если во время работы разрядились аккумуляторы до 10%, то меч выключается, проигрывается звук умирающего телефона.
        Файл "09/001.mp3" на карте.
      <br>
	  7. Взмах меча - воспроизводит звук взмаха. Проигрывает произвольный файл из папки "06" или "07" на карте. 
        В режиме трещания - изменяет частоту треска.
      <br>
	  8. Удар - воспроизводит звук удара и вспыхивает белым. Проигрывает произвольный файл из папки "04" или "05" на карте.
</p>

      <h3>В режиме регулировки громкости.</h3>
<p>
      1. Короткое нажатие кнопки 1 - увеличить громкость.
      <br>
	  2. Короткое нажатие кнопки 2 - уменьшить громкость.
      <br>
	  3. Одновременное нажатие кнопок 1 и 2 - переходит в обычный режим.
      <br>
	  4. Если кнопки не нажимать 4 секунды - переходит в обычный режим.
</p>

      <h3>В режиме настроек.</h3>
<p>
      1. Короткое нажатие кнопки 2 - выбор параметра для изменения. 
        Светодиод моргает соответствующее количество раз:
      <br>  1 - выбор фонового звука. Выбирает файлы из папки "03" на карте + режим трещания.
      <br>  2 - выбор режима работы кнопки 2 в режиме меча - кнопка 2 меняет фоновый звук или воспроизводит цитату
      <br>  3 - выбор режима Меч - Лампа - Факел
      <br>  4 - выбор звука включения. Выбирает файлы из папки "01" на карте.
      <br>  5 - выбор звука выключения. Выбирает файлы из папки "02" на карте.
      <br>
	  2. Короткое нажатие кнопки 1 - изменить текущий параметр по кругу. 
        Если текущий параметр - звук включения или выключения, то выбранный звук проигрывается один раз.
      <br>
	  3. Нажатие кнопки 2 более 0.8 секунд - выход из настроек. 
        Выбранные текущие параметры, текущая громкость и цвет записываются в энергонезависимую память.
        При следующем включении параметры меча будут восстановлены из памяти.
</p>


<h2>Схема</h2>
<p>
<img src="images/schema.png"/>
</p>


<h2>Детали</h2>
<p>
Макетки - https://aliexpress.ru/item/32575817765.html
</p>

<h2>Замечания по сборке</h2>
<p>
Удобная программка для редактирование звука: <a href="https://www.audacityteam.org/">Audacity</a> для тех, кто хочет сделать свои звуки.
</p>
<p>
Карта памяти - любая micro SD карта. Нужно скопировать содержимое папки SDsounds проекта в корень карты.
</p>
<p>
Прежде, чем подключать питание к усилителю звука, нужно отрегулировать напряжение на выходе понижайки 5В с помощью микроподстроечника на ней.
</p>
<p>
На одной макетке (30х70мм) собрал ATMega328 Nano, DFPlayer, MP6050, усилок, понижайку. Впаял разъёмы для подключения питания и светодиода, кнопок, динамика, светодиодной ленты. MP6050 поставил перпендикулярно оси меча и закруглил углы. Эта макетка шириной 30 мм идеально входит в трубу меча.
<br><br>Фотки на половину собранного модуля
<br>
<img src="images/main1.jpg" width="400"/>
<img src="images/main2.jpg" width="400"/>
</p>
<p>
Кнопки управления собрал на другой макетке (20х80мм) и на стойках прикрутил ее к ручке меча изнутри. В ручке под кнопки просверлил 2 отверстия 12мм и еще 2 под винты 3мм для стоек.
<br><br>Фотки собранного модуля
<br>
<img src="images/buttons1.jpg" width="400"/>
<img src="images/buttons2.jpg" width="800"/>
</p>
<p>
Можно разрезать макетку 50х70мм на две части 30х70 и 20х70.
</p>
<p>
Аккумы спаял между собой полосками жести от консервной банки. Использовал паяльную кислоту и паяльник 100 Вт. Мощный паяльник нужен, чтобы процесс пайки занимал 2 - 3 секунды. Иначе можно испортить аккум. Сделал батарею 2 + 1 аккум, обмотал малярным (бумажным) скотчем, чтобы не коротило ничего. 2 аккума по толщине идеально входят в трубу ручки 40мм. И еще один входит под плату с кнопками.
</p>
<p>
Разъем под зарядку и кнопку включения выбрал самые тонкие - 8мм. Чтобы сильно не торчали, утопил их внутрь ручки. Для этого в месте их крепления вставил в раструб кусок трубы того же диаметра - 40мм. В раструбе сделал отверстия по 10мм, чтобы кнопка и гдездо зарядки провалились через них, а в куске трубы под ними отверстия по 8мм и закрутил изнутри гайками.
У меня была кнопка с очень мягкой пластмассой. Поэтому паять надо аккуратно - не перегревать.
</p>
<p>
Разъем для балансировщика вывел с другого конца трубы и оставил его внутри. То есть чтобы заряжать через него, нужно разобрать меч. Но, надеюсь, это понадобится делать не часто. Если саморазряд у каждого из трех аккумов одинаковый, то штатного гнезда для зарядки должно хватать. Но если меч перестал заряжаться на 100%, то можно попробовать зарядить его балансировщиком.
</p>
<p>
Отверстия для смягчения звука можно не делать, если динамик не ловит резонанс и нет искажений. Но кому-то звук может больше понравиться с ними - на любителя. По моим ощущениям с отверстиями басы уменьшались.
</p>
<p>
Динамик 40мм нормально заходит в уплотнительную резинку раструба. Эти резинки мне попадались двух типов - с и без канавки посередине. Нужно найти с канавкой, в нее динамик и входит. Штатно в этой канавке лежит пластиковая пружинка для жесткости, как я понимаю. Ее можно оставить. Если динамик упирается контактами, то можно их аккуратно убрать и подпаяться к проводам катушки напрямую. В местах возможного касания с корпусом использовать термоусадочную трубку для изоляции.
</p>
<p>
Для защиты динамика использовал сетку для раковины из нержавейки. Ее нужно обрезать хорошими ножницами и сточить острые углы. Я использовал болгарку для этого.
</p>
<p>
Светодиодную ленту собрал из двух одинаковых кусков по 16 сегментов (48 диодов). Склеил их обратными сторонами (с клеем) в одинаковом направлении стрелок. Контакты 12V, GND, DI на двух кусках подпаял параллельно и вывел шлейф с разъемом. Закрутил ленту в упаковочную пенку в виде колбаски и обмотал прозрачным скотчем. В результате должна получиться толщина на 2-3 мм меньше внутреннего диаметра трубы. Запихнул полученную колбаску в трубу меча. Пенка хорошо убирает зернистость - отдельные светодиоды не видны. И в ней лента не болтается и не боится ударов. У меня пенка осталась от какой-то посылки, но можно использовать ту, что стелится под ламинат.

<br><br>Фотки процесса сборки лезвия меча
<br>
<img src="images/blade1.jpg" width="800"/>
<img src="images/blade2.jpg" width="800"/>
<img src="images/blade3.jpg" width="800"/>
<img src="images/blade4.jpg" width="800"/>
<img src="images/blade5.jpg" width="800"/>
</p>
<p>
